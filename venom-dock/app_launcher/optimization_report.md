# تقرير تحسين `app_launcher.c`

بعد فحص الملف `linux/app_launcher/app_launcher.c`، تبين أن هناك مشاكل أداء مشابهة لتلك التي كانت في `window_manager.c`، ولكنها أكثر حدة نظراً لعدد التطبيقات الكبير.

## 1. المشاكل الرئيسية (Performance Bottlenecks)

### أ. قراءة القرص المتكررة (Repeated Disk I/O)
في كل مرة يتم استدعاء `launcher_get_installed_apps`، يتم تنفيذ:
```c
GList *all_apps = g_app_info_get_all();
```
هذه الدالة تقوم بمسح جميع مجلدات التطبيقات (`/usr/share/applications`, `~/.local/share/applications`, إلخ) وقراءة مئات ملفات `.desktop`. هذا بطيء جداً ويسبب تأخيراً ملحوظاً عند فتح القائمة.

### ب. معالجة الأيقونات المكلفة (Expensive Icon Processing)
يتم تحميل وضغط أيقونة **كل تطبيق** في كل مرة:
```c
gdk_pixbuf_save_to_buffer(pixbuf, &buffer, &buffer_size, "png", ...);
```
إذا كان لديك 100 تطبيق، فهذا يعني 100 عملية ضغط PNG في كل مرة تفتح فيها القائمة! هذا يستهلك المعالج بشكل هائل.

### ج. تخصيص الذاكرة (Memory Allocation)
يتم تخصيص ذاكرة جديدة لكل عنصر وكل سلسلة نصية وكل أيقونة في كل استدعاء، ثم يتم تحريرها. هذا يسبب ضغطاً على مدير الذاكرة (Memory Allocator).

## 2. الحلول المقترحة (Proposed Solutions)

### التخزين المؤقت الشامل (Global Caching)
يجب بناء "ذاكرة تخزين مؤقت" (Cache) في الذاكرة تحتوي على قائمة التطبيقات الجاهزة.

1.  **هيكل تخزين داخلي:**
    إنشاء قائمة ثابتة (Static List) تحتفظ ببيانات التطبيقات (الاسم، المسار، وبيانات الأيقونة المضغوطة جاهزة).

2.  **التحميل لمرة واحدة (Lazy Loading):**
    - عند الاستدعاء الأول، يتم بناء القائمة وضغط الأيقونات وتخزينها.
    - في الاستدعاءات اللاحقة، يتم نسخ البيانات من الذاكرة مباشرة (Deep Copy) وإرسالها لـ Flutter.
    - عملية النسخ (`memcpy`) أسرع بآلاف المرات من قراءة الملفات وضغط الصور.

3.  **تحديث عند الطلب (Optional Refresh):**
    يمكن إضافة دالة `launcher_refresh_apps()` لإجبار إعادة بناء القائمة إذا قام المستخدم بتثبيت تطبيق جديد، بدلاً من إعادة بنائها كل مرة.

## 3. الفوائد المتوقعة
- **سرعة استجابة فورية:** فتح القائمة سيكون لحظياً (أقل من 1ms بعد المرة الأولى).
- **توفير المعالج:** إزالة الحمل الزائد من ضغط الصور.
- **تقليل استهلاك الطاقة:** مهم جداً للأجهزة المحمولة (Laptops).

## 4. خطة العمل
1. تعريف هيكل داخلي `CachedApp`.
2. إنشاء متغير `static CachedApp *app_cache`.
3. تعديل `launcher_get_installed_apps` للتحقق من `app_cache`:
   - إذا كان فارغاً -> قم بالتحميل والمعالجة.
   - إذا كان موجوداً -> انسخ البيانات وأعدها.
